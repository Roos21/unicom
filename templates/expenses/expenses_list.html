{% extends 'base.html' %}
{% load permissions_extras %}
{% load list_filters %}
{% load form_tags %}
{% block title %}
  Dépenses
{% endblock %}
{% block page_title %}
  Liste des Dépenses
{% endblock %}

{% block content %}
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-semibold">Toutes les dépenses</h2>

    {% if user|has_permission:'manage_treasury' %}
      <a href="{% url 'expenses:expense_create' %}" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Nouvelle dépense</a>
    {% endif %}
  </div>

  <!-- Filtre -->
  <form method="get" class="mb-4 flex flex-wrap gap-4 items-end">
    <div class="flex flex-col w-64">
      <label class="text-sm font-medium text-gray-700">Titre</label>
      {{ filter.form.title }}
    </div>

    <div class="flex flex-col w-48">
      <label class="text-sm font-medium text-gray-700">Statut</label>
      {{ filter.form.status }}
    </div>
    <div class="flex-none">
      <label class="block text-sm font-medium text-gray-700">Date (du ... au ...)</label>
      {{ filter.form.created_at|add_class:'w-[195px] border border-gray-300 rounded px-2 py-1 h-9' }}
    </div>

    <div class="flex gap-2">
      <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Filtrer</button>
      <a href="{% url 'expenses:expense_list' %}" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Réinitialiser</a>
    </div>
  </form>

  <div class="overflow-x-auto bg-white shadow rounded-lg">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titre</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Compte</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Créé par</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for expense in expenses %}
          <tr>
            <td class="px-6 py-4">{{ expense.title }}</td>
            <td class="px-6 py-4">{{ expense.amount|floatformat:2 }} FCFA</td>
            <td class="px-6 py-4">{{ expense.account.name }}</td>
            <td class="px-6 py-4">
              {% if expense.status == 'APPROVED' %}
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Approuvée</span>
              {% elif expense.status == 'PENDING' %}
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">En attente</span>
              {% elif expense.status == 'IN_REVIEW' %}
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">En validation</span>
              {% elif expense.status == 'REJECTED' %}
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Rejetée</span>
              {% elif expense.status == 'PAID' %}
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Payée</span>
              {% endif %}
            </td>
            <td class="px-6 py-4">{{ expense.created_by.username }}</td>
            <td class="px-6 py-4 space-x-2">
              {% if user|has_permission:'validate_depenses' and expense.status|in_list:'PENDING,IN_REVIEW' %}
                <a href="{% url 'expenses:approve_expense' expense.id %}" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Valider</a>
              {% endif %}
              {% if user|has_permission:'manage_treasury' %}
                <a href="{% url 'expenses:expense_update' expense.id %}" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modifier</a>
                <a href="{% url 'expenses:expense_delete' expense.id %}" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Supprimer</a>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6" class="px-6 py-4 text-center text-gray-500">Aucune dépense trouvée.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination Tailwind -->
  {% if expenses.has_other_pages %}
    <div class="flex justify-center mt-4 space-x-2">
      {% if expenses.has_previous %}
        <a href="?page=1" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">&laquo; Première</a>
        <a href="?page={{ expenses.previous_page_number }}" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Précédente</a>
      {% endif %}

      {% for num in expenses.paginator.page_range %}
        {% if expenses.number == num %}
          <span class="px-3 py-1 bg-blue-500 text-white rounded">{{ num }}</span>
        {% elif num > expenses.number|add:'-3' and num < expenses.number|add:'3' %}
          <a href="?page={{ num }}" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">{{ num }}</a>
        {% endif %}
      {% endfor %}

      {% if expenses.has_next %}
        <a href="?page={{ expenses.next_page_number }}" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Suivante</a>
        <a href="?page={{ expenses.paginator.num_pages }}" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Dernière &raquo;</a>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}
